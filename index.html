<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body style="margin:0;padding:0">
<div align="center">
    <canvas id="webglCanvas" style="width:100vw; height:100vh;" width=1000 height=1000></canvas>
    <div style="position: absolute; bottom:20px; right:40px;">
        <input type="color" id="colorPicker"
            value="#4DCCFF">
        <!-- <label for="head">Color</label> -->
        <button id="undoButton" style="font-size: 1.0em; margin-left:5px;">Undo</button>
        <button id="clearButton" style="font-size: 1.0em; margin-left:5px;">Clear</button>
        
    </div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/gl-matrix-min.js"></script>
<script src="js/preloadjs-0.6.2.min.js"></script>
<script src="js/assetUtils.js"></script>
<script src="js/webGLUtils.js"></script>
<script src="js/algorithms/Delaunay.js"></script>
<script src="js/algorithms/Equalize.js"></script>
<script src="js/algorithms/pruneTrianglesAndElevateVertices.js"></script>
<script src="js/algorithms/selfIntersect.js"></script>
<script src="js/algorithm.js"></script>
<script src="js/scene.js"></script>
<script src="js/canvas.js"></script>

<script>
    runWebGL();

    function runWebGL(){
        assetUtils.loadFiles([
            {id:'frag',src:'./shaders/fragmentShader.frag'},
            {id:'vert',src:'./shaders/vertexShader.vert'},
            {id:'frag_line',src:'./shaders/fragmentShader_line.frag'},
            {id:'vert_line',src:'./shaders/vertexShader_line.vert'},
            {id:'frag_wire',src:'./shaders/fragmentShader_wireframe.frag'},
            {id:'vert_wire',src:'./shaders/vertexShader_wireframe.vert'}],
            (filesLoaded)=>{
                const data = {}
                data.fragmentShaderText = filesLoaded[0];
                data.vertexShaderText = filesLoaded[1];
                data.fragmentShaderLineText = filesLoaded[2];
                data.vertexShaderLineText = filesLoaded[3];
                data.fragmentShaderWireframeText = filesLoaded[4];
                data.vertexShaderWireframeText = filesLoaded[5];
                const updateWebGL = getUpdateFunction(data);
            window.requestAnimationFrame(updateWebGL);
            })
    }

    function getUpdateFunction(data){
        
        webGLUtils.initializeWegGL('webglCanvas');

        webGLUtils.createGlslProgram('program_line', data.vertexShaderLineText, data.fragmentShaderLineText, 
        {
            uniforms:[],
            attributes:[
                {name:'vert_position'},
            ]
        })

        webGLUtils.createGlslProgram('program_wireframe', data.vertexShaderWireframeText,       data.fragmentShaderWireframeText, 
            {
                uniforms:[
                    {name:'xform_projMat', type:'Matrix4fv'},
                    {name:'xform_viewMat', type:'Matrix4fv'},
                    {name:'xform_modelMat', type:'Matrix4fv'},
                ], 
                attributes:[
                    {name:'vert_position'},
                ]
            })

        webGLUtils.createGlslProgram('program0', data.vertexShaderText, data.fragmentShaderText, 
        {
            uniforms:[
                {name:'xform_projMat', type:'Matrix4fv'},
                {name:'xform_viewMat', type:'Matrix4fv'},
                {name:'xform_modelMat', type:'Matrix4fv'},
                {name:'lightPos', type:'3fv'},
                {name:'color', type:'4fv'},
            ], 
            attributes:[
                {name:'vert_position'},
                {name:'vert_normal'},
                {name:'vert_barycentric'}
            ]
        })

        canvas.initializeMouseEvents();

        const updateWebGL = ()=>{

            scene.initCamera();
            scene.initLights();
            
            webGLUtils.clearScreen([0.8,0.8,0.8,1.0]);

            if(canvas.getMode()=='create'){
                //show path
                webGLUtils.drawLine(canvas.getStroke(),'program_line',{},{
                    positionAttributeId:'vert_position',
                })
            }

            if(canvas.getMode()!=='create'){
                const wireframe = false;
                
                // show object
                webGLUtils.drawShape(scene.object.vertices, scene.object.indices, {},
                wireframe?'program_wireframe':'program0', {
                    'xform_projMat':scene.view.projMat,
                    'xform_viewMat':scene.view.viewMat,
                    'xform_modelMat':scene.view.modelMat,
                    'lightPos':scene.view.lightPos,
                    'color':canvas.getColor(),
                }, {positionAttributeId:'vert_position',normalAttributeId:'vert_normal',
                barycentricAttributeId:'vert_barycentric'},wireframe)
            }
            
            window.requestAnimationFrame(updateWebGL);
        }
        return updateWebGL;
    }

</script>

</body>
</html>